<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>Lucid Analytics Dashboard</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    :root {
      --bg-primary: #0f0f0f;
      --bg-secondary: #1a1a1a;
      --bg-tertiary: #2a2a2a;
      --text-primary: #ffffff;
      --text-secondary: #a0a0a0;
      --accent: #6366f1;
      --accent-hover: #4f46e5;
      --success: #10b981;
      --warning: #f59e0b;
      --error: #ef4444;
      --border: #3a3a3a;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
      background: var(--bg-primary);
      color: var(--text-primary);
      line-height: 1.6;
      -webkit-font-smoothing: antialiased;
      overflow-x: hidden;
    }

    .container {
      max-width: 1400px;
      margin: 0 auto;
      padding: 20px;
    }

    header {
      text-align: center;
      padding: 30px 20px;
      background: linear-gradient(135deg, var(--bg-secondary) 0%, var(--bg-primary) 100%);
      border-bottom: 1px solid var(--border);
    }

    h1 {
      font-size: clamp(24px, 5vw, 36px);
      font-weight: 700;
      margin-bottom: 10px;
      background: linear-gradient(135deg, #6366f1 0%, #8b5cf6 100%);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
    }

    .subtitle {
      color: var(--text-secondary);
      font-size: clamp(14px, 3vw, 16px);
    }

    /* Config Section */
    .config-section {
      background: var(--bg-secondary);
      border-radius: 12px;
      padding: 16px;
      margin: 20px 0;
      border: 1px solid var(--border);
    }

    .config-row {
      display: flex;
      gap: 12px;
      flex-wrap: wrap;
      align-items: center;
    }

    .config-input {
      flex: 1;
      min-width: 200px;
      background: var(--bg-tertiary);
      color: var(--text-primary);
      border: 1px solid var(--border);
      border-radius: 8px;
      padding: 10px 12px;
      font-size: 14px;
      font-family: 'Monaco', 'Menlo', monospace;
    }

    .config-input:focus {
      outline: none;
      border-color: var(--accent);
    }

    .btn {
      background: var(--accent);
      color: white;
      border: none;
      padding: 10px 20px;
      border-radius: 8px;
      font-size: 14px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s;
    }

    .btn:hover:not(:disabled) {
      background: var(--accent-hover);
    }

    .btn:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }

    .btn-secondary {
      background: var(--bg-tertiary);
      border: 1px solid var(--border);
    }

    .btn-secondary:hover:not(:disabled) {
      background: var(--bg-primary);
      border-color: var(--accent);
    }

    /* Health Status Banner */
    .health-banner {
      display: flex;
      align-items: center;
      gap: 12px;
      padding: 12px 16px;
      border-radius: 8px;
      margin: 20px 0;
      font-weight: 500;
    }

    .health-banner.healthy {
      background: rgba(16, 185, 129, 0.1);
      border: 1px solid var(--success);
      color: var(--success);
    }

    .health-banner.degraded {
      background: rgba(245, 158, 11, 0.1);
      border: 1px solid var(--warning);
      color: var(--warning);
    }

    .health-banner.unhealthy {
      background: rgba(239, 68, 68, 0.1);
      border: 1px solid var(--error);
      color: var(--error);
    }

    .health-dot {
      width: 10px;
      height: 10px;
      border-radius: 50%;
      animation: pulse 2s infinite;
    }

    .healthy .health-dot { background: var(--success); }
    .degraded .health-dot { background: var(--warning); }
    .unhealthy .health-dot { background: var(--error); }

    @keyframes pulse {
      0%, 100% { opacity: 1; }
      50% { opacity: 0.5; }
    }

    /* Summary Cards */
    .summary-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 16px;
      margin: 20px 0;
    }

    .summary-card {
      background: var(--bg-secondary);
      border: 1px solid var(--border);
      border-radius: 12px;
      padding: 20px;
    }

    .summary-card h3 {
      font-size: 12px;
      text-transform: uppercase;
      color: var(--text-secondary);
      margin-bottom: 8px;
      letter-spacing: 0.5px;
    }

    .summary-card .value {
      font-size: 28px;
      font-weight: 700;
      color: var(--text-primary);
    }

    .summary-card .value.cost {
      color: var(--success);
    }

    .summary-card .subvalue {
      font-size: 13px;
      color: var(--text-secondary);
      margin-top: 4px;
    }

    /* Chart Section */
    .chart-section {
      background: var(--bg-secondary);
      border: 1px solid var(--border);
      border-radius: 12px;
      padding: 20px;
      margin: 20px 0;
    }

    .chart-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 16px;
      flex-wrap: wrap;
      gap: 12px;
    }

    .chart-header h2 {
      font-size: 18px;
      color: var(--text-primary);
    }

    .chart-controls {
      display: flex;
      gap: 8px;
      flex-wrap: wrap;
    }

    .chart-controls select {
      background: var(--bg-tertiary);
      color: var(--text-primary);
      border: 1px solid var(--border);
      border-radius: 6px;
      padding: 6px 12px;
      font-size: 13px;
      cursor: pointer;
    }

    .chart-controls select:focus {
      outline: none;
      border-color: var(--accent);
    }

    .chart-container {
      position: relative;
      height: 300px;
    }

    /* Tables */
    .table-section {
      background: var(--bg-secondary);
      border: 1px solid var(--border);
      border-radius: 12px;
      overflow: hidden;
      margin: 20px 0;
    }

    .table-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 16px 20px;
      background: var(--bg-tertiary);
      border-bottom: 1px solid var(--border);
    }

    .table-header h2 {
      font-size: 16px;
      color: var(--text-primary);
    }

    .table-wrapper {
      overflow-x: auto;
    }

    table {
      width: 100%;
      border-collapse: collapse;
    }

    th {
      padding: 12px 16px;
      text-align: left;
      font-size: 12px;
      font-weight: 600;
      color: var(--text-secondary);
      text-transform: uppercase;
      letter-spacing: 0.5px;
      border-bottom: 1px solid var(--border);
      white-space: nowrap;
    }

    td {
      padding: 12px 16px;
      font-size: 14px;
      border-bottom: 1px solid var(--border);
      white-space: nowrap;
    }

    tr:last-child td {
      border-bottom: none;
    }

    tbody tr:hover {
      background: var(--bg-tertiary);
    }

    .status-badge {
      display: inline-block;
      padding: 4px 8px;
      border-radius: 4px;
      font-size: 12px;
      font-weight: 500;
    }

    .status-badge.success {
      background: rgba(16, 185, 129, 0.2);
      color: var(--success);
    }

    .status-badge.error {
      background: rgba(239, 68, 68, 0.2);
      color: var(--error);
    }

    /* Two Column Layout */
    .two-column {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(400px, 1fr));
      gap: 20px;
    }

    /* Performance Metrics */
    .metrics-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
      gap: 12px;
      padding: 16px;
    }

    .metric-item {
      text-align: center;
      padding: 12px;
      background: var(--bg-tertiary);
      border-radius: 8px;
    }

    .metric-item .label {
      font-size: 11px;
      text-transform: uppercase;
      color: var(--text-secondary);
      margin-bottom: 4px;
    }

    .metric-item .value {
      font-size: 20px;
      font-weight: 600;
      color: var(--text-primary);
    }

    /* Collapsible Section */
    .collapsible {
      background: var(--bg-secondary);
      border: 1px solid var(--border);
      border-radius: 12px;
      margin: 20px 0;
    }

    .collapsible-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 16px 20px;
      cursor: pointer;
      user-select: none;
    }

    .collapsible-header h2 {
      font-size: 16px;
      color: var(--text-primary);
    }

    .collapsible-toggle {
      font-size: 20px;
      color: var(--text-secondary);
      transition: transform 0.3s;
    }

    .collapsible-toggle.open {
      transform: rotate(180deg);
    }

    .collapsible-content {
      max-height: 0;
      overflow: hidden;
      transition: max-height 0.3s ease-out;
    }

    .collapsible-content.open {
      max-height: 2000px;
    }

    .collapsible-inner {
      padding: 0 20px 20px;
    }

    /* Chat Interface (inside collapsible) */
    .chat-examples {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      margin-bottom: 16px;
    }

    .example-btn {
      background: var(--bg-tertiary);
      color: var(--text-primary);
      border: 1px solid var(--border);
      padding: 8px 12px;
      border-radius: 6px;
      font-size: 13px;
      cursor: pointer;
      transition: all 0.2s;
    }

    .example-btn:hover {
      background: var(--bg-primary);
      border-color: var(--accent);
    }

    .chat-input-group {
      display: flex;
      gap: 12px;
    }

    .chat-input-group textarea {
      flex: 1;
      background: var(--bg-tertiary);
      color: var(--text-primary);
      border: 1px solid var(--border);
      border-radius: 8px;
      padding: 12px;
      font-size: 14px;
      font-family: inherit;
      resize: vertical;
      min-height: 50px;
    }

    .chat-input-group textarea:focus {
      outline: none;
      border-color: var(--accent);
    }

    .chat-result {
      margin-top: 16px;
      display: none;
    }

    .chat-result.active {
      display: block;
    }

    .sql-display {
      background: #000;
      color: var(--success);
      padding: 12px;
      border-radius: 8px;
      font-family: 'Monaco', 'Menlo', monospace;
      font-size: 12px;
      overflow-x: auto;
      margin: 12px 0;
    }

    /* Loading States */
    .loading-overlay {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0, 0, 0, 0.7);
      z-index: 1000;
      justify-content: center;
      align-items: center;
    }

    .loading-overlay.active {
      display: flex;
    }

    .spinner {
      width: 40px;
      height: 40px;
      border: 4px solid var(--border);
      border-top-color: var(--accent);
      border-radius: 50%;
      animation: spin 1s linear infinite;
    }

    @keyframes spin {
      to { transform: rotate(360deg); }
    }

    .empty-state {
      text-align: center;
      padding: 40px 20px;
      color: var(--text-secondary);
    }

    .error-message {
      background: rgba(239, 68, 68, 0.1);
      border: 1px solid var(--error);
      border-radius: 8px;
      padding: 12px 16px;
      color: var(--error);
      margin: 12px 0;
    }

    footer {
      text-align: center;
      padding: 30px 20px;
      color: var(--text-secondary);
      font-size: 13px;
    }

    /* Responsive */
    @media (max-width: 768px) {
      .container {
        padding: 12px;
      }

      .two-column {
        grid-template-columns: 1fr;
      }

      .chart-container {
        height: 250px;
      }

      .config-row {
        flex-direction: column;
      }

      .config-input {
        width: 100%;
      }
    }
  </style>
</head>
<body>
  <header>
    <h1>Lucid Analytics</h1>
    <p class="subtitle">Real-time API usage monitoring and analytics</p>
  </header>

  <div class="container">
    <!-- Configuration -->
    <div class="config-section">
      <div class="config-row">
        <input type="text" id="apiUrl" class="config-input" placeholder="https://your-api.railway.app">
        <input type="password" id="appKey" class="config-input" placeholder="Your APP_KEY">
        <button class="btn" onclick="loadDashboard()">Load Dashboard</button>
        <button class="btn btn-secondary" onclick="refreshData()">Refresh</button>
      </div>
    </div>

    <!-- Health Status Banner -->
    <div class="health-banner healthy" id="healthBanner" style="display: none;">
      <div class="health-dot"></div>
      <span id="healthStatus">All systems operational</span>
      <span style="margin-left: auto; font-size: 13px;" id="healthDetails"></span>
    </div>

    <!-- Summary Cards -->
    <div class="summary-grid" id="summaryGrid">
      <div class="summary-card">
        <h3>Today's Cost</h3>
        <div class="value cost" id="todayCost">$0.00</div>
        <div class="subvalue" id="todayRequests">0 requests</div>
      </div>
      <div class="summary-card">
        <h3>This Week</h3>
        <div class="value cost" id="weekCost">$0.00</div>
        <div class="subvalue" id="weekRequests">0 requests</div>
      </div>
      <div class="summary-card">
        <h3>This Month</h3>
        <div class="value cost" id="monthCost">$0.00</div>
        <div class="subvalue" id="monthRequests">0 requests</div>
      </div>
      <div class="summary-card">
        <h3>All Time</h3>
        <div class="value cost" id="allTimeCost">$0.00</div>
        <div class="subvalue" id="allTimeRequests">0 requests</div>
      </div>
    </div>

    <!-- Usage Chart -->
    <div class="chart-section">
      <div class="chart-header">
        <h2>Usage Over Time</h2>
        <div class="chart-controls">
          <select id="chartMetric" onchange="updateChart()">
            <option value="cost">Cost ($)</option>
            <option value="requests">Requests</option>
            <option value="tokens">Tokens</option>
            <option value="errors">Errors</option>
          </select>
          <select id="chartPeriod" onchange="loadTimeseries()">
            <option value="hourly">Hourly (24h)</option>
            <option value="daily" selected>Daily (7 days)</option>
            <option value="daily-30">Daily (30 days)</option>
          </select>
          <select id="chartApp" onchange="loadTimeseries()">
            <option value="">All Apps</option>
          </select>
        </div>
      </div>
      <div class="chart-container">
        <canvas id="usageChart"></canvas>
      </div>
    </div>

    <!-- Two Column: Apps & Providers -->
    <div class="two-column">
      <!-- Per-App Breakdown -->
      <div class="table-section">
        <div class="table-header">
          <h2>Usage by App</h2>
        </div>
        <div class="table-wrapper">
          <table>
            <thead>
              <tr>
                <th>App ID</th>
                <th>Requests</th>
                <th>Cost</th>
                <th>Errors</th>
                <th>Last Used</th>
              </tr>
            </thead>
            <tbody id="appsTable">
              <tr><td colspan="5" class="empty-state">No data yet</td></tr>
            </tbody>
          </table>
        </div>
      </div>

      <!-- Per-Provider Breakdown -->
      <div class="table-section">
        <div class="table-header">
          <h2>Usage by Provider</h2>
        </div>
        <div class="table-wrapper">
          <table>
            <thead>
              <tr>
                <th>Provider</th>
                <th>Requests</th>
                <th>Cost</th>
              </tr>
            </thead>
            <tbody id="providersTable">
              <tr><td colspan="3" class="empty-state">No data yet</td></tr>
            </tbody>
          </table>
        </div>
      </div>
    </div>

    <!-- Performance Metrics -->
    <div class="table-section">
      <div class="table-header">
        <h2>Performance (Last 24 Hours)</h2>
      </div>
      <div class="metrics-grid" id="metricsGrid">
        <div class="metric-item">
          <div class="label">Avg Latency</div>
          <div class="value" id="avgLatency">--</div>
        </div>
        <div class="metric-item">
          <div class="label">P95 Latency</div>
          <div class="value" id="p95Latency">--</div>
        </div>
        <div class="metric-item">
          <div class="label">Success Rate</div>
          <div class="value" id="successRate">--</div>
        </div>
        <div class="metric-item">
          <div class="label">Error Rate</div>
          <div class="value" id="errorRate">--</div>
        </div>
        <div class="metric-item">
          <div class="label">Total Requests</div>
          <div class="value" id="totalRequests24h">--</div>
        </div>
      </div>
    </div>

    <!-- Recent Activity -->
    <div class="table-section">
      <div class="table-header">
        <h2>Recent Activity</h2>
      </div>
      <div class="table-wrapper">
        <table>
          <thead>
            <tr>
              <th>Time</th>
              <th>App</th>
              <th>Endpoint</th>
              <th>Provider</th>
              <th>Model</th>
              <th>Cost</th>
              <th>Duration</th>
              <th>Status</th>
            </tr>
          </thead>
          <tbody id="activityTable">
            <tr><td colspan="8" class="empty-state">No activity yet</td></tr>
          </tbody>
        </table>
      </div>
    </div>

    <!-- AI Chat (Collapsible) -->
    <div class="collapsible">
      <div class="collapsible-header" onclick="toggleChat()">
        <h2>AI Analytics Chat</h2>
        <span class="collapsible-toggle" id="chatToggle">&#9660;</span>
      </div>
      <div class="collapsible-content" id="chatContent">
        <div class="collapsible-inner">
          <p style="color: var(--text-secondary); margin-bottom: 16px;">
            Ask questions about your usage data in natural language.
          </p>
          <div class="chat-examples">
            <button class="example-btn" onclick="setQuestion('How much did each app spend this week?')">Spending by app</button>
            <button class="example-btn" onclick="setQuestion('Show me the most expensive models')">Top models by cost</button>
            <button class="example-btn" onclick="setQuestion('What are the failed requests today?')">Failed requests</button>
            <button class="example-btn" onclick="setQuestion('Average response time by endpoint')">Latency analysis</button>
          </div>
          <div class="chat-input-group">
            <textarea id="chatQuestion" placeholder="Ask a question about your API usage..."></textarea>
            <button class="btn" onclick="askQuestion()" id="askBtn">Ask</button>
          </div>
          <div class="chat-result" id="chatResult"></div>
        </div>
      </div>
    </div>
  </div>

  <footer>
    Built with Lucid Studio API
  </footer>

  <!-- Loading Overlay -->
  <div class="loading-overlay" id="loadingOverlay">
    <div class="spinner"></div>
  </div>

  <script>
    let usageChart = null;
    let timeseriesData = [];

    // Load saved config
    window.addEventListener('DOMContentLoaded', () => {
      const savedApiUrl = localStorage.getItem('lucid_api_url');
      const savedAppKey = localStorage.getItem('lucid_app_key');

      if (savedApiUrl) document.getElementById('apiUrl').value = savedApiUrl;
      if (savedAppKey) document.getElementById('appKey').value = savedAppKey;

      // Auto-load if config exists
      if (savedApiUrl && savedAppKey) {
        loadDashboard();
      }

      // Initialize chart
      initChart();
    });

    // Save config on change
    document.getElementById('apiUrl').addEventListener('change', (e) => {
      localStorage.setItem('lucid_api_url', e.target.value);
    });

    document.getElementById('appKey').addEventListener('change', (e) => {
      localStorage.setItem('lucid_app_key', e.target.value);
    });

    function getConfig() {
      return {
        apiUrl: document.getElementById('apiUrl').value.trim(),
        appKey: document.getElementById('appKey').value.trim(),
      };
    }

    function showLoading(show) {
      document.getElementById('loadingOverlay').classList.toggle('active', show);
    }

    async function loadDashboard() {
      const { apiUrl, appKey } = getConfig();
      if (!apiUrl || !appKey) {
        alert('Please enter API URL and APP_KEY');
        return;
      }

      showLoading(true);

      try {
        // Load all data in parallel
        const [dashboardRes, healthRes] = await Promise.all([
          fetch(`${apiUrl}/v1/analytics/dashboard`, {
            headers: { 'x-app-key': appKey }
          }),
          fetch(`${apiUrl}/v1/analytics/health`, {
            headers: { 'x-app-key': appKey }
          })
        ]);

        if (!dashboardRes.ok) throw new Error('Failed to load dashboard data');
        if (!healthRes.ok) throw new Error('Failed to load health data');

        const dashboard = await dashboardRes.json();
        const health = await healthRes.json();

        updateSummary(dashboard.summary);
        updateAppsTable(dashboard.apps);
        updateProvidersTable(dashboard.providers);
        updateActivityTable(dashboard.recentActivity);
        updateHealth(health);
        populateAppFilter(dashboard.apps);

        // Load timeseries
        await loadTimeseries();

      } catch (error) {
        alert('Error loading dashboard: ' + error.message);
      } finally {
        showLoading(false);
      }
    }

    async function refreshData() {
      await loadDashboard();
    }

    function updateSummary(summary) {
      document.getElementById('todayCost').textContent = '$' + summary.today.cost;
      document.getElementById('todayRequests').textContent = summary.today.requests + ' requests';

      document.getElementById('weekCost').textContent = '$' + summary.week.cost;
      document.getElementById('weekRequests').textContent = summary.week.requests + ' requests';

      document.getElementById('monthCost').textContent = '$' + summary.month.cost;
      document.getElementById('monthRequests').textContent = summary.month.requests + ' requests';

      document.getElementById('allTimeCost').textContent = '$' + summary.allTime.cost;
      document.getElementById('allTimeRequests').textContent = summary.allTime.requests + ' requests';
    }

    function updateAppsTable(apps) {
      const tbody = document.getElementById('appsTable');
      if (!apps || apps.length === 0) {
        tbody.innerHTML = '<tr><td colspan="5" class="empty-state">No apps yet</td></tr>';
        return;
      }

      tbody.innerHTML = apps.map(app => `
        <tr>
          <td><strong>${escapeHtml(app.appId)}</strong></td>
          <td>${app.requests.toLocaleString()}</td>
          <td style="color: var(--success);">$${app.cost}</td>
          <td>${app.errors}</td>
          <td style="color: var(--text-secondary);">${formatTime(app.lastUsed)}</td>
        </tr>
      `).join('');
    }

    function updateProvidersTable(providers) {
      const tbody = document.getElementById('providersTable');
      if (!providers || providers.length === 0) {
        tbody.innerHTML = '<tr><td colspan="3" class="empty-state">No providers yet</td></tr>';
        return;
      }

      tbody.innerHTML = providers.map(p => `
        <tr>
          <td><strong>${escapeHtml(p.provider)}</strong></td>
          <td>${p.requests.toLocaleString()}</td>
          <td style="color: var(--success);">$${p.cost}</td>
        </tr>
      `).join('');
    }

    function updateActivityTable(activity) {
      const tbody = document.getElementById('activityTable');
      if (!activity || activity.length === 0) {
        tbody.innerHTML = '<tr><td colspan="8" class="empty-state">No recent activity</td></tr>';
        return;
      }

      tbody.innerHTML = activity.map(a => `
        <tr>
          <td style="color: var(--text-secondary);">${formatTime(a.timestamp)}</td>
          <td>${escapeHtml(a.appId)}</td>
          <td>${escapeHtml(a.endpoint || '-')}</td>
          <td>${escapeHtml(a.provider || '-')}</td>
          <td style="font-size: 12px;">${escapeHtml(a.model || '-')}</td>
          <td style="color: var(--success);">$${a.cost}</td>
          <td>${a.duration ? a.duration + 'ms' : '-'}</td>
          <td>
            <span class="status-badge ${a.status < 400 ? 'success' : 'error'}">
              ${a.status}
            </span>
          </td>
        </tr>
      `).join('');
    }

    function updateHealth(health) {
      const banner = document.getElementById('healthBanner');
      banner.style.display = 'flex';
      banner.className = 'health-banner ' + health.status;

      const statusText = {
        healthy: 'All systems operational',
        degraded: 'System experiencing issues',
        unhealthy: 'System degraded'
      };

      document.getElementById('healthStatus').textContent = statusText[health.status] || health.status;
      document.getElementById('healthDetails').textContent =
        `${health.lastHour.requests} requests/hr | ${health.lastHour.successRate}% success`;

      // Update metrics
      document.getElementById('avgLatency').textContent = health.last24Hours.avgLatency + 'ms';
      document.getElementById('p95Latency').textContent = health.last24Hours.p95Latency + 'ms';
      document.getElementById('successRate').textContent = health.last24Hours.successRate + '%';
      document.getElementById('errorRate').textContent = health.last24Hours.errorRate + '%';
      document.getElementById('totalRequests24h').textContent = health.last24Hours.requests.toLocaleString();
    }

    function populateAppFilter(apps) {
      const select = document.getElementById('chartApp');
      select.innerHTML = '<option value="">All Apps</option>';
      apps.forEach(app => {
        select.innerHTML += `<option value="${escapeHtml(app.appId)}">${escapeHtml(app.appId)}</option>`;
      });
    }

    function initChart() {
      const ctx = document.getElementById('usageChart').getContext('2d');
      usageChart = new Chart(ctx, {
        type: 'line',
        data: {
          labels: [],
          datasets: [{
            label: 'Cost ($)',
            data: [],
            borderColor: '#6366f1',
            backgroundColor: 'rgba(99, 102, 241, 0.1)',
            fill: true,
            tension: 0.4,
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            legend: {
              display: false,
            }
          },
          scales: {
            x: {
              grid: {
                color: '#2a2a2a',
              },
              ticks: {
                color: '#a0a0a0',
              }
            },
            y: {
              grid: {
                color: '#2a2a2a',
              },
              ticks: {
                color: '#a0a0a0',
              },
              beginAtZero: true,
            }
          }
        }
      });
    }

    async function loadTimeseries() {
      const { apiUrl, appKey } = getConfig();
      if (!apiUrl || !appKey) return;

      const periodSelect = document.getElementById('chartPeriod').value;
      const appId = document.getElementById('chartApp').value;

      let period = 'daily';
      let days = 7;

      if (periodSelect === 'hourly') {
        period = 'hourly';
        days = 1;
      } else if (periodSelect === 'daily-30') {
        period = 'daily';
        days = 30;
      }

      try {
        let url = `${apiUrl}/v1/analytics/timeseries?period=${period}&days=${days}`;
        if (appId) url += `&appId=${encodeURIComponent(appId)}`;

        const response = await fetch(url, {
          headers: { 'x-app-key': appKey }
        });

        if (!response.ok) throw new Error('Failed to load timeseries');

        const data = await response.json();
        timeseriesData = data.data;
        updateChart();

      } catch (error) {
        console.error('Timeseries error:', error);
      }
    }

    function updateChart() {
      if (!usageChart || !timeseriesData) return;

      const metric = document.getElementById('chartMetric').value;

      const labels = timeseriesData.map(d => {
        if (d.time.includes('T')) {
          return d.time.split('T')[1] || d.time;
        }
        return d.time;
      });

      const data = timeseriesData.map(d => d[metric] || 0);

      const colors = {
        cost: '#10b981',
        requests: '#6366f1',
        tokens: '#8b5cf6',
        errors: '#ef4444',
      };

      const labelText = {
        cost: 'Cost ($)',
        requests: 'Requests',
        tokens: 'Tokens',
        errors: 'Errors',
      };

      usageChart.data.labels = labels;
      usageChart.data.datasets[0].data = data;
      usageChart.data.datasets[0].label = labelText[metric];
      usageChart.data.datasets[0].borderColor = colors[metric];
      usageChart.data.datasets[0].backgroundColor = colors[metric] + '20';
      usageChart.update();
    }

    // Chat functionality
    function toggleChat() {
      const content = document.getElementById('chatContent');
      const toggle = document.getElementById('chatToggle');
      content.classList.toggle('open');
      toggle.classList.toggle('open');
    }

    function setQuestion(text) {
      document.getElementById('chatQuestion').value = text;
    }

    async function askQuestion() {
      const { apiUrl, appKey } = getConfig();
      const question = document.getElementById('chatQuestion').value.trim();

      if (!question) return;
      if (!apiUrl || !appKey) {
        alert('Please configure API URL and APP_KEY first');
        return;
      }

      const resultDiv = document.getElementById('chatResult');
      const askBtn = document.getElementById('askBtn');

      askBtn.disabled = true;
      resultDiv.innerHTML = '<p style="color: var(--text-secondary);">Analyzing...</p>';
      resultDiv.classList.add('active');

      try {
        const response = await fetch(`${apiUrl}/v1/analytics/chat`, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'x-app-key': appKey
          },
          body: JSON.stringify({ question })
        });

        const data = await response.json();

        if (!response.ok) {
          let html = `<div class="error-message"><strong>${escapeHtml(data.error || 'Error')}</strong>`;
          if (data.reason) html += `<p>${escapeHtml(data.reason)}</p>`;
          if (data.suggestion) html += `<p>${escapeHtml(data.suggestion)}</p>`;
          if (data.examples) {
            html += '<p style="margin-top: 8px;"><strong>Try:</strong></p>';
            html += '<div class="chat-examples" style="margin-top: 8px;">';
            data.examples.forEach(ex => {
              html += `<button class="example-btn" onclick="setQuestion('${escapeHtml(ex)}')">${escapeHtml(ex)}</button>`;
            });
            html += '</div>';
          }
          html += '</div>';
          resultDiv.innerHTML = html;
          return;
        }

        let html = '';
        if (data.sql) {
          html += `<div class="sql-display">${escapeHtml(data.sql)}</div>`;
        }
        if (data.explanation) {
          html += `<p style="color: var(--text-secondary); margin-bottom: 12px;">${escapeHtml(data.explanation)}</p>`;
        }
        if (data.results && data.results.length > 0) {
          html += generateResultTable(data.results);
        } else if (data.error) {
          html += `<div class="error-message">${escapeHtml(data.error)}</div>`;
        } else {
          html += '<p style="color: var(--text-secondary);">No results found.</p>';
        }

        resultDiv.innerHTML = html;

      } catch (error) {
        resultDiv.innerHTML = `<div class="error-message">${escapeHtml(error.message)}</div>`;
      } finally {
        askBtn.disabled = false;
      }
    }

    function generateResultTable(data) {
      if (!data || data.length === 0) return '';

      const headers = Object.keys(data[0]);
      let html = '<div class="table-wrapper" style="margin-top: 12px;"><table>';
      html += '<thead><tr>';
      headers.forEach(h => {
        html += `<th>${escapeHtml(h)}</th>`;
      });
      html += '</tr></thead><tbody>';

      data.forEach(row => {
        html += '<tr>';
        headers.forEach(h => {
          const val = row[h];
          html += `<td>${val !== null && val !== undefined ? escapeHtml(String(val)) : ''}</td>`;
        });
        html += '</tr>';
      });

      html += '</tbody></table></div>';
      return html;
    }

    function formatTime(timestamp) {
      if (!timestamp) return '-';
      const date = new Date(timestamp);
      const now = new Date();
      const diff = now - date;

      if (diff < 60000) return 'Just now';
      if (diff < 3600000) return Math.floor(diff / 60000) + 'm ago';
      if (diff < 86400000) return Math.floor(diff / 3600000) + 'h ago';
      return date.toLocaleDateString();
    }

    function escapeHtml(text) {
      const div = document.createElement('div');
      div.textContent = text;
      return div.innerHTML;
    }

    // Enter to submit chat
    document.getElementById('chatQuestion').addEventListener('keydown', (e) => {
      if (e.key === 'Enter' && !e.shiftKey) {
        e.preventDefault();
        askQuestion();
      }
    });
  </script>
</body>
</html>
