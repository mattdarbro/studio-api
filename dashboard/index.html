<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>Lucid Analytics Dashboard</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    :root {
      --bg-primary: #0f0f0f;
      --bg-secondary: #1a1a1a;
      --bg-tertiary: #2a2a2a;
      --text-primary: #ffffff;
      --text-secondary: #a0a0a0;
      --accent: #6366f1;
      --accent-hover: #4f46e5;
      --success: #10b981;
      --error: #ef4444;
      --border: #3a3a3a;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
      background: var(--bg-primary);
      color: var(--text-primary);
      line-height: 1.6;
      -webkit-font-smoothing: antialiased;
      overflow-x: hidden;
    }

    .container {
      max-width: 1200px;
      margin: 0 auto;
      padding: 20px;
    }

    header {
      text-align: center;
      padding: 40px 20px;
      background: linear-gradient(135deg, var(--bg-secondary) 0%, var(--bg-primary) 100%);
      border-bottom: 1px solid var(--border);
    }

    h1 {
      font-size: clamp(24px, 5vw, 36px);
      font-weight: 700;
      margin-bottom: 10px;
      background: linear-gradient(135deg, #6366f1 0%, #8b5cf6 100%);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
    }

    .subtitle {
      color: var(--text-secondary);
      font-size: clamp(14px, 3vw, 16px);
    }

    .chat-container {
      background: var(--bg-secondary);
      border-radius: 16px;
      padding: 24px;
      margin: 20px 0;
      border: 1px solid var(--border);
      box-shadow: 0 4px 6px rgba(0, 0, 0, 0.3);
    }

    .examples {
      margin-bottom: 20px;
    }

    .examples h3 {
      font-size: 14px;
      color: var(--text-secondary);
      margin-bottom: 12px;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }

    .example-buttons {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
    }

    .example-btn {
      background: var(--bg-tertiary);
      color: var(--text-primary);
      border: 1px solid var(--border);
      padding: 10px 16px;
      border-radius: 8px;
      font-size: 14px;
      cursor: pointer;
      transition: all 0.2s;
      -webkit-tap-highlight-color: transparent;
    }

    .example-btn:active {
      transform: scale(0.95);
    }

    .example-btn:hover {
      background: var(--bg-primary);
      border-color: var(--accent);
    }

    .input-group {
      display: flex;
      gap: 12px;
      margin-bottom: 20px;
    }

    textarea {
      flex: 1;
      background: var(--bg-tertiary);
      color: var(--text-primary);
      border: 1px solid var(--border);
      border-radius: 12px;
      padding: 16px;
      font-size: 16px;
      font-family: inherit;
      resize: vertical;
      min-height: 60px;
      max-height: 200px;
      transition: border-color 0.2s;
    }

    textarea:focus {
      outline: none;
      border-color: var(--accent);
    }

    textarea::placeholder {
      color: var(--text-secondary);
    }

    .btn {
      background: var(--accent);
      color: white;
      border: none;
      padding: 16px 32px;
      border-radius: 12px;
      font-size: 16px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s;
      -webkit-tap-highlight-color: transparent;
      min-width: 120px;
    }

    .btn:active {
      transform: scale(0.95);
    }

    .btn:hover:not(:disabled) {
      background: var(--accent-hover);
    }

    .btn:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }

    .loading {
      display: none;
      text-align: center;
      padding: 20px;
      color: var(--text-secondary);
    }

    .loading.active {
      display: block;
    }

    .spinner {
      display: inline-block;
      width: 20px;
      height: 20px;
      border: 3px solid var(--border);
      border-top-color: var(--accent);
      border-radius: 50%;
      animation: spin 1s linear infinite;
    }

    @keyframes spin {
      to { transform: rotate(360deg); }
    }

    .result {
      display: none;
      margin-top: 20px;
    }

    .result.active {
      display: block;
    }

    .sql-query {
      background: var(--bg-primary);
      border: 1px solid var(--border);
      border-radius: 12px;
      padding: 16px;
      margin-bottom: 20px;
    }

    .sql-query h3 {
      font-size: 14px;
      color: var(--text-secondary);
      margin-bottom: 12px;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }

    .sql-code {
      background: #000;
      color: #10b981;
      padding: 12px;
      border-radius: 8px;
      font-family: 'Monaco', 'Menlo', monospace;
      font-size: 13px;
      overflow-x: auto;
      white-space: pre-wrap;
      word-break: break-all;
    }

    .explanation {
      background: var(--bg-primary);
      border: 1px solid var(--border);
      border-radius: 12px;
      padding: 16px;
      margin-bottom: 20px;
    }

    .explanation h3 {
      font-size: 14px;
      color: var(--text-secondary);
      margin-bottom: 8px;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }

    .explanation p {
      color: var(--text-primary);
      line-height: 1.6;
    }

    .results-table {
      background: var(--bg-primary);
      border: 1px solid var(--border);
      border-radius: 12px;
      overflow: hidden;
    }

    .results-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 16px;
      background: var(--bg-tertiary);
      border-bottom: 1px solid var(--border);
    }

    .results-header h3 {
      font-size: 14px;
      color: var(--text-secondary);
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }

    .export-btn {
      background: var(--bg-secondary);
      color: var(--text-primary);
      border: 1px solid var(--border);
      padding: 8px 16px;
      border-radius: 6px;
      font-size: 13px;
      cursor: pointer;
      transition: all 0.2s;
    }

    .export-btn:hover {
      background: var(--bg-primary);
      border-color: var(--accent);
    }

    table {
      width: 100%;
      border-collapse: collapse;
      overflow-x: auto;
      display: block;
    }

    thead {
      background: var(--bg-tertiary);
    }

    th {
      padding: 12px;
      text-align: left;
      font-size: 13px;
      font-weight: 600;
      color: var(--text-secondary);
      border-bottom: 1px solid var(--border);
      white-space: nowrap;
    }

    td {
      padding: 12px;
      font-size: 14px;
      border-bottom: 1px solid var(--border);
      white-space: nowrap;
    }

    tr:last-child td {
      border-bottom: none;
    }

    tbody tr:hover {
      background: var(--bg-tertiary);
    }

    .error {
      background: rgba(239, 68, 68, 0.1);
      border: 1px solid var(--error);
      border-radius: 12px;
      padding: 16px;
      color: var(--error);
      margin-top: 20px;
    }

    .error h3 {
      font-size: 14px;
      margin-bottom: 8px;
    }

    .empty-state {
      text-align: center;
      padding: 40px 20px;
      color: var(--text-secondary);
    }

    .empty-state svg {
      width: 64px;
      height: 64px;
      margin-bottom: 16px;
      opacity: 0.5;
    }

    .config-section {
      background: var(--bg-secondary);
      border-radius: 16px;
      padding: 24px;
      margin: 20px 0;
      border: 1px solid var(--border);
    }

    .config-section h3 {
      font-size: 14px;
      color: var(--text-secondary);
      margin-bottom: 12px;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }

    .config-input {
      width: 100%;
      background: var(--bg-tertiary);
      color: var(--text-primary);
      border: 1px solid var(--border);
      border-radius: 8px;
      padding: 12px;
      font-size: 14px;
      font-family: 'Monaco', 'Menlo', monospace;
      margin-bottom: 8px;
    }

    .config-input:focus {
      outline: none;
      border-color: var(--accent);
    }

    .help-text {
      font-size: 12px;
      color: var(--text-secondary);
      margin-top: 4px;
    }

    .integration-guide {
      background: var(--bg-secondary);
      border-radius: 16px;
      padding: 24px;
      margin: 20px 0;
      border: 1px solid var(--border);
    }

    .integration-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      cursor: pointer;
      user-select: none;
      -webkit-tap-highlight-color: transparent;
    }

    .integration-header h3 {
      font-size: 16px;
      color: var(--text-primary);
      margin: 0;
    }

    .integration-toggle {
      font-size: 24px;
      color: var(--text-secondary);
      transition: transform 0.3s;
    }

    .integration-toggle.open {
      transform: rotate(180deg);
    }

    .integration-content {
      max-height: 0;
      overflow: hidden;
      transition: max-height 0.3s ease-out;
    }

    .integration-content.open {
      max-height: 2000px;
      transition: max-height 0.5s ease-in;
    }

    .integration-content pre {
      background: var(--bg-primary);
      border: 1px solid var(--border);
      border-radius: 8px;
      padding: 12px;
      overflow-x: auto;
      margin: 12px 0;
    }

    .integration-content code {
      color: var(--success);
      font-family: 'Monaco', 'Menlo', monospace;
      font-size: 13px;
    }

    .integration-content p {
      margin: 12px 0;
      line-height: 1.6;
    }

    .integration-content ul {
      margin: 12px 0 12px 20px;
      line-height: 1.8;
    }

    .integration-content strong {
      color: var(--accent);
    }

    footer {
      text-align: center;
      padding: 40px 20px;
      color: var(--text-secondary);
      font-size: 14px;
    }

    @media (max-width: 768px) {
      .container {
        padding: 12px;
      }

      .chat-container {
        padding: 16px;
      }

      .input-group {
        flex-direction: column;
      }

      .btn {
        width: 100%;
      }

      table {
        font-size: 12px;
      }

      th, td {
        padding: 8px;
      }
    }

    /* iOS Safari specific fixes */
    @supports (-webkit-touch-callout: none) {
      textarea {
        font-size: 16px; /* Prevents zoom on focus */
      }
    }

    /* Documentation Section */
    .docs-section {
      background: var(--bg-secondary);
      border-radius: 16px;
      padding: 24px;
      margin: 20px 0;
      border: 1px solid var(--border);
    }

    .docs-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      cursor: pointer;
      -webkit-tap-highlight-color: transparent;
    }

    .docs-header h2 {
      font-size: clamp(18px, 4vw, 24px);
      font-weight: 600;
      color: var(--text-primary);
    }

    .toggle-icon {
      font-size: 24px;
      color: var(--text-secondary);
      transition: transform 0.3s;
    }

    .toggle-icon.open {
      transform: rotate(180deg);
    }

    .docs-content {
      max-height: 0;
      overflow: hidden;
      transition: max-height 0.3s ease-out;
    }

    .docs-content.open {
      max-height: 5000px;
      transition: max-height 0.5s ease-in;
    }

    .docs-inner {
      padding-top: 20px;
    }

    .docs-section h3 {
      font-size: 18px;
      color: var(--text-primary);
      margin: 24px 0 12px 0;
      padding-bottom: 8px;
      border-bottom: 1px solid var(--border);
    }

    .docs-section h4 {
      font-size: 16px;
      color: var(--accent);
      margin: 16px 0 8px 0;
    }

    .docs-section p {
      color: var(--text-secondary);
      margin-bottom: 12px;
      line-height: 1.8;
    }

    .docs-section ul {
      list-style: none;
      margin: 12px 0;
      padding: 0;
    }

    .docs-section li {
      color: var(--text-secondary);
      margin: 8px 0;
      padding-left: 24px;
      position: relative;
    }

    .docs-section li:before {
      content: "‚Üí";
      position: absolute;
      left: 0;
      color: var(--accent);
    }

    .code-block {
      background: #000;
      border: 1px solid var(--border);
      border-radius: 8px;
      padding: 16px;
      margin: 12px 0;
      overflow-x: auto;
      font-family: 'Monaco', 'Menlo', monospace;
      font-size: 13px;
      line-height: 1.6;
    }

    .code-block code {
      color: #10b981;
      white-space: pre;
    }

    .code-comment {
      color: var(--text-secondary);
    }

    .highlight {
      color: var(--accent);
      font-weight: 600;
    }

    .benefit-card {
      background: var(--bg-primary);
      border: 1px solid var(--border);
      border-radius: 8px;
      padding: 16px;
      margin: 12px 0;
    }

    .benefit-card h4 {
      color: var(--success);
      margin-top: 0;
    }
  </style>
</head>
<body>
  <header>
    <h1>Lucid Analytics</h1>
    <p class="subtitle">AI-powered analytics for your API usage</p>
  </header>

  <div class="container">
    <!-- Configuration Section -->
    <div class="config-section">
      <h3>Configuration</h3>
      <input
        type="text"
        id="apiUrl"
        class="config-input"
        placeholder="https://your-api.railway.app"
        value="">
      <p class="help-text">Enter your Studio API URL (deployed on Railway)</p>

      <input
        type="password"
        id="appKey"
        class="config-input"
        placeholder="Your APP_KEY"
        value="">
      <p class="help-text">Enter your APP_KEY for authentication</p>
    </div>

    <!-- Integration Guide -->
    <div class="integration-guide">
      <div class="integration-header" onclick="toggleIntegration()">
        <h3>üìö How to Integrate with Your Legacy Apps</h3>
        <span class="integration-toggle" id="integrationToggle">‚ñº</span>
      </div>
      <div class="integration-content" id="integrationContent">
        <p style="margin-top: 16px;">
          Want to add analytics tracking to your existing applications? Follow these steps to route your LLM requests through Studio API and start tracking usage.
        </p>

        <p><strong>Step 1: Update Your API Calls</strong></p>
        <p>Replace direct OpenAI/Anthropic calls with Studio API:</p>
        <pre><code>// Before (Direct OpenAI):
const response = await openai.chat.completions.create({
  model: 'gpt-4',
  messages: [{ role: 'user', content: 'Hello' }]
});

// After (Through Studio API):
const response = await fetch('YOUR_API_URL/v1/chat', {
  method: 'POST',
  headers: {
    'Content-Type': 'application/json',
    'x-app-key': 'YOUR_APP_KEY',
    'x-app-id': 'my-legacy-app',  // ‚Üê Track per-app usage
    'x-user-id': userId,           // ‚Üê Optional: track per-user
  },
  body: JSON.stringify({
    kind: 'chat.default',
    messages: [{ role: 'user', content: 'Hello' }]
  })
});</code></pre>

        <p><strong>Step 2: Add Environment Variables</strong></p>
        <p>Update your app's <code>.env</code> file:</p>
        <pre><code>STUDIO_API_URL=https://your-api.railway.app
STUDIO_API_KEY=your-app-key-here
APP_ID=my-legacy-app  # Identifies your app in analytics</code></pre>

        <p><strong>Step 3: Deploy and Track</strong></p>
        <ul>
          <li>Deploy your updated app</li>
          <li>Make some test requests</li>
          <li>Come back to this dashboard and ask: <em>"How much did my-legacy-app spend today?"</em></li>
        </ul>

        <p><strong>Multiple Apps?</strong></p>
        <p>Track different apps separately using unique <code>x-app-id</code> headers:</p>
        <pre><code>// Mobile app
headers: { 'x-app-id': 'mobile-ios' }

// Web dashboard
headers: { 'x-app-id': 'web-dashboard' }

// Background jobs
headers: { 'x-app-id': 'background-worker' }</code></pre>

        <p><strong>Example Analytics Questions:</strong></p>
        <ul>
          <li>"How much did mobile-ios spend vs web-dashboard this week?"</li>
          <li>"Show me all failed requests for my-legacy-app"</li>
          <li>"What's the average response time by app?"</li>
        </ul>

        <p>
          <strong>üìñ Full Documentation:</strong> Check the
          <a href="https://github.com/mattdarbro/studio-api/blob/main/INTEGRATION.md#integrating-analytics-into-legacy-apps"
             target="_blank"
             style="color: var(--accent); text-decoration: none;">
            INTEGRATION.md guide
          </a>
          for complete migration patterns and troubleshooting.
        </p>
      </div>
    </div>

    <!-- Chat Interface -->
    <div class="chat-container">
      <div class="examples">
        <h3>Example Questions</h3>
        <div class="example-buttons">
          <button class="example-btn" onclick="setQuestion('How much did arno-ios spend last week?')">
            arno-ios spending last week
          </button>
          <button class="example-btn" onclick="setQuestion('Which app used the most OpenAI requests yesterday?')">
            Most OpenAI usage yesterday
          </button>
          <button class="example-btn" onclick="setQuestion('Show me total costs by provider')">
            Costs by provider
          </button>
          <button class="example-btn" onclick="setQuestion('What are the top 5 most expensive models?')">
            Top 5 expensive models
          </button>
          <button class="example-btn" onclick="setQuestion('Show me all failed requests in the last 24 hours')">
            Failed requests (24h)
          </button>
        </div>
      </div>

      <div class="input-group">
        <textarea
          id="question"
          placeholder="Ask a question about your API usage... (e.g., 'How much did my apps spend on Claude today?')"
        ></textarea>
        <button class="btn" onclick="askQuestion()" id="askBtn">Ask</button>
      </div>

      <div class="loading" id="loading">
        <div class="spinner"></div>
        <p>Analyzing your question...</p>
      </div>

      <div class="result" id="result">
        <!-- Results will be inserted here -->
      </div>
    </div>

    <!-- Documentation Section -->
    <div class="docs-section">
      <div class="docs-header" onclick="toggleDocs()">
        <h2>How to Adopt Studio API in Your Apps</h2>
        <span class="toggle-icon" id="docsToggle">‚ñº</span>
      </div>
      <div class="docs-content" id="docsContent">
        <div class="docs-inner">
          <p>
            Studio API is a centralized gateway that simplifies LLM integration across all your apps.
            Instead of managing multiple API keys and providers in each app, authenticate once and
            access OpenAI, Anthropic, Grok, Replicate, and ElevenLabs through a single endpoint.
          </p>

          <h3>Quick Start</h3>

          <h4>1. Authentication</h4>
          <p>Studio API supports two authentication methods:</p>

          <div class="code-block"><code><span class="code-comment">// Method 1: JWT Token (Recommended for production)</span>
let request = URLRequest(url: url)
request.setValue("Bearer \(jwtToken)", forHTTPHeaderField: "Authorization")

<span class="code-comment">// Method 2: App Key (Simple, for testing)</span>
let request = URLRequest(url: url)
request.setValue(appKey, forHTTPHeaderField: "x-app-key")</code></div>

          <h4>2. Add App Tracking (Important!)</h4>
          <p>Add the <span class="highlight">x-app-id</span> header to track usage per app:</p>

          <div class="code-block"><code><span class="code-comment">// Add this to ALL your API requests</span>
request.setValue("arno-ios", forHTTPHeaderField: "x-app-id")
<span class="code-comment">// or</span>
request.setValue("studio-mobile", forHTTPHeaderField: "x-app-id")</code></div>

          <p>This enables per-app analytics in this dashboard!</p>

          <h3>Available Endpoints</h3>

          <h4>Chat Completions</h4>
          <p>Works with OpenAI, Anthropic, and Grok models:</p>

          <div class="code-block"><code>POST https://your-api.railway.app/v1/chat/completions

{
  "model": "gpt-5",
  "messages": [
    { "role": "user", "content": "Hello!" }
  ]
}</code></div>

          <h4>Image Generation</h4>
          <p>Access DALL-E and Flux models:</p>

          <div class="code-block"><code>POST https://your-api.railway.app/v1/images/generations

{
  "model": "dall-e-3",
  "prompt": "A futuristic city",
  "size": "1024x1024"
}</code></div>

          <h4>Music Generation</h4>
          <p>Generate music with ElevenLabs:</p>

          <div class="code-block"><code>POST https://your-api.railway.app/v1/music/create

{
  "text": "Epic orchestral music",
  "duration": 30
}</code></div>

          <h3>Complete Swift Example</h3>

          <div class="code-block"><code><span class="code-comment">// NetworkManager.swift</span>
import Foundation

class StudioAPIClient {
    let baseURL = "https://your-api.railway.app"
    let appKey = "your-app-key"
    let appId = "arno-ios" <span class="code-comment">// Your app identifier</span>

    func chatCompletion(messages: [[String: String]]) async throws -> Data {
        let url = URL(string: "\(baseURL)/v1/chat/completions")!
        var request = URLRequest(url: url)
        request.httpMethod = "POST"
        request.setValue("application/json", forHTTPHeaderField: "Content-Type")
        request.setValue(appKey, forHTTPHeaderField: "x-app-key")
        request.setValue(appId, forHTTPHeaderField: "x-app-id") <span class="code-comment">// Track usage!</span>

        let body: [String: Any] = [
            "model": "gpt-5",
            "messages": messages
        ]
        request.httpBody = try JSONSerialization.data(withJSONObject: body)

        let (data, _) = try await URLSession.shared.data(for: request)
        return data
    }
}</code></div>

          <h3>Why Use Studio API?</h3>

          <div class="benefit-card">
            <h4>Centralized Management</h4>
            <p>
              Update API keys once on the server instead of pushing app updates.
              Add new providers without changing client code.
            </p>
          </div>

          <div class="benefit-card">
            <h4>Cost Tracking & Analytics</h4>
            <p>
              Track exactly how much each app spends on each provider.
              Query usage with natural language in this dashboard.
            </p>
          </div>

          <div class="benefit-card">
            <h4>Unified Interface</h4>
            <p>
              One API for OpenAI, Anthropic, Grok, Replicate, and ElevenLabs.
              Switch providers without changing client code.
            </p>
          </div>

          <div class="benefit-card">
            <h4>Security</h4>
            <p>
              API keys never stored in mobile apps.
              Revoke access instantly without app updates.
            </p>
          </div>

          <h3>Migration Checklist</h3>

          <ul>
            <li>Replace direct OpenAI/Anthropic SDK calls with Studio API endpoints</li>
            <li>Add authentication (x-app-key or JWT token)</li>
            <li>Add x-app-id header to all requests for tracking</li>
            <li>Update base URL to your Railway deployment</li>
            <li>Test with a few requests</li>
            <li>Monitor usage in this dashboard</li>
            <li>Remove provider SDKs from your app (optional)</li>
          </ul>

          <h3>Need Help?</h3>
          <p>
            Questions about integration? Check the <a href="https://your-api.railway.app/v1/models"
            target="_blank" style="color: var(--accent);">model catalog</a> for all available models,
            or query this analytics dashboard to see example API usage patterns.
          </p>
        </div>
      </div>
    </div>
  </div>

  <footer>
    Built with Lucid Studio API ‚Ä¢ Powered by AI
  </footer>

  <script>
    // Load saved configuration from localStorage
    window.addEventListener('DOMContentLoaded', () => {
      const savedApiUrl = localStorage.getItem('lucid_api_url');
      const savedAppKey = localStorage.getItem('lucid_app_key');

      if (savedApiUrl) document.getElementById('apiUrl').value = savedApiUrl;
      if (savedAppKey) document.getElementById('appKey').value = savedAppKey;
    });

    // Save configuration to localStorage when changed
    document.getElementById('apiUrl').addEventListener('change', (e) => {
      localStorage.setItem('lucid_api_url', e.target.value);
    });

    document.getElementById('appKey').addEventListener('change', (e) => {
      localStorage.setItem('lucid_app_key', e.target.value);
    });

    function toggleIntegration() {
      const content = document.getElementById('integrationContent');
      const toggle = document.getElementById('integrationToggle');

      content.classList.toggle('open');
      toggle.classList.toggle('open');
    }

    function setQuestion(text) {
      document.getElementById('question').value = text;
      document.getElementById('question').focus();
    }

    async function askQuestion() {
      const question = document.getElementById('question').value.trim();
      const apiUrl = document.getElementById('apiUrl').value.trim();
      const appKey = document.getElementById('appKey').value.trim();

      if (!question) {
        alert('Please enter a question');
        return;
      }

      if (!apiUrl) {
        alert('Please enter your API URL in the configuration section');
        return;
      }

      if (!appKey) {
        alert('Please enter your APP_KEY in the configuration section');
        return;
      }

      // Show loading state
      document.getElementById('loading').classList.add('active');
      document.getElementById('result').classList.remove('active');
      document.getElementById('askBtn').disabled = true;

      try {
        const response = await fetch(`${apiUrl}/v1/analytics/chat`, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'x-app-key': appKey
          },
          body: JSON.stringify({ question })
        });

        if (!response.ok) {
          const errorData = await response.json();
          throw new Error(errorData.error || `HTTP ${response.status}`);
        }

        const data = await response.json();
        displayResult(data);

      } catch (error) {
        displayError(error.message);
      } finally {
        document.getElementById('loading').classList.remove('active');
        document.getElementById('askBtn').disabled = false;
      }
    }

    function displayResult(data) {
      const resultDiv = document.getElementById('result');

      if (data.error) {
        displayError(data.error);
        return;
      }

      let html = '';

      // SQL Query
      html += `
        <div class="sql-query">
          <h3>Generated SQL Query</h3>
          <div class="sql-code">${escapeHtml(data.sql)}</div>
        </div>
      `;

      // Explanation
      if (data.explanation) {
        html += `
          <div class="explanation">
            <h3>What this query does</h3>
            <p>${escapeHtml(data.explanation)}</p>
          </div>
        `;
      }

      // Results Table
      if (data.results && data.results.length > 0) {
        html += `
          <div class="results-table">
            <div class="results-header">
              <h3>Results (${data.resultCount} rows)</h3>
              <button class="export-btn" onclick="exportToCSV()">Export CSV</button>
            </div>
            ${generateTable(data.results)}
          </div>
        `;

        // Store results for export
        window.currentResults = data.results;
      } else {
        html += `
          <div class="empty-state">
            <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20 13V6a2 2 0 00-2-2H6a2 2 0 00-2 2v7m16 0v5a2 2 0 01-2 2H6a2 2 0 01-2-2v-5m16 0h-2.586a1 1 0 00-.707.293l-2.414 2.414a1 1 0 01-.707.293h-3.172a1 1 0 01-.707-.293l-2.414-2.414A1 1 0 006.586 13H4"></path>
            </svg>
            <p>No results found</p>
          </div>
        `;
      }

      resultDiv.innerHTML = html;
      resultDiv.classList.add('active');
    }

    function displayError(message) {
      const resultDiv = document.getElementById('result');
      resultDiv.innerHTML = `
        <div class="error">
          <h3>Error</h3>
          <p>${escapeHtml(message)}</p>
        </div>
      `;
      resultDiv.classList.add('active');
    }

    function generateTable(data) {
      if (!data || data.length === 0) return '';

      const headers = Object.keys(data[0]);

      let html = '<table><thead><tr>';
      headers.forEach(header => {
        html += `<th>${escapeHtml(header)}</th>`;
      });
      html += '</tr></thead><tbody>';

      data.forEach(row => {
        html += '<tr>';
        headers.forEach(header => {
          const value = row[header];
          html += `<td>${value !== null && value !== undefined ? escapeHtml(String(value)) : ''}</td>`;
        });
        html += '</tr>';
      });

      html += '</tbody></table>';
      return html;
    }

    function exportToCSV() {
      if (!window.currentResults || window.currentResults.length === 0) {
        alert('No results to export');
        return;
      }

      const data = window.currentResults;
      const headers = Object.keys(data[0]);

      let csv = headers.join(',') + '\n';

      data.forEach(row => {
        const values = headers.map(header => {
          const value = row[header];
          const stringValue = value !== null && value !== undefined ? String(value) : '';
          // Escape quotes and wrap in quotes if contains comma
          return stringValue.includes(',') || stringValue.includes('"')
            ? `"${stringValue.replace(/"/g, '""')}"`
            : stringValue;
        });
        csv += values.join(',') + '\n';
      });

      // Download
      const blob = new Blob([csv], { type: 'text/csv' });
      const url = window.URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = `lucid-analytics-${new Date().toISOString().split('T')[0]}.csv`;
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);
      window.URL.revokeObjectURL(url);
    }

    function escapeHtml(text) {
      const div = document.createElement('div');
      div.textContent = text;
      return div.innerHTML;
    }

    // Allow Enter to submit (with Shift+Enter for new line)
    document.getElementById('question').addEventListener('keydown', (e) => {
      if (e.key === 'Enter' && !e.shiftKey) {
        e.preventDefault();
        askQuestion();
      }
    });

    // Toggle documentation section
    function toggleDocs() {
      const content = document.getElementById('docsContent');
      const toggle = document.getElementById('docsToggle');

      if (content.classList.contains('open')) {
        content.classList.remove('open');
        toggle.classList.remove('open');
      } else {
        content.classList.add('open');
        toggle.classList.add('open');
      }
    }
  </script>
</body>
</html>
